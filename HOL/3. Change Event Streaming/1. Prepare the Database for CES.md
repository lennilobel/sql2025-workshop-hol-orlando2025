# Prepare the Database for CES

To get started, let's configure a database. We'll enable the database for Change Event Streaming (CES), create a stream group, and define stored procedures to simulate transactional activity.

> **Note:** Each attendee requires their own Event Hub that has been provisioned in advance by the instructor. In the code snippets for this lab, be sure to supply your first ane last name for the placeholders in the event hub name `ces-hub-<firstname-lastname>` (for example, `ces-hub-john-smith`).

## Create and Configure the Database

Run the following T-SQL to create and use the `CesDemo` database.

```sql
USE master
GO

CREATE DATABASE CesDemo
GO

USE CesDemo
GO
```

### Create the Database Master Key

You must create a database master key to securely store the credential to access the Azure Event Hub resource for this lab. This key is encrypted by a password. Only one master key is needed and permitted per database, so if it already exists from a previous lab, this command will not recreate it.

```sql
IF NOT EXISTS (SELECT * FROM sys.symmetric_keys WHERE name = '##MS_DatabaseMasterKey##')
    CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'H@rd2Gue$$P@$$w0rd'
```

### Create the Credential Used by CES

This credential holds the SAS token enabling access to the Event Hub that SQL Server will stream events to as data changes in the database. Replace the placeholder with the token provided by your instructor.

```sql
CREATE DATABASE SCOPED CREDENTIAL SqlCesCredential
WITH
    IDENTITY = 'SHARED ACCESS SIGNATURE',
    SECRET = '<provided by instructor>'
```

### Enable CES

Run the following query to verify that (at this stage) CES is currently not enabled on any databases:

```sql
SELECT * FROM sys.databases WHERE is_event_stream_enabled = 1
```

Now run this statement to enable CES for the current database. This allows SQL Server to start capturing change events.

```sql
EXEC sys.sp_enable_event_stream
```

Now re-run the previous query to confirm CES is enabled for the current database (CesDemo):

```sql
SELECT * FROM sys.databases WHERE is_event_stream_enabled = 1
```

### Create the Event Stream Group

Now let's create the stream group. This is a SQL Server concept that allows you to group multiple tables together for change event streaming. The group will be configured to send events to an Azure Event Hub using the AMQP protocol.

> **IMPORTANT:** SQL Server *stream groups* should not to be confused with Event Hub *consumer groups*. The latter allows multiple consumers to read from the same event hub independently, by using distinct consumer groups. In the next lab, you will leverage consumer groups to maintain isolation from other students, since all students will be sharing the same event hub at the same time and streaming data changes from their respective databases.

```sql
EXEC sys.sp_create_event_stream_group
  @stream_group_name      = 'SqlCesGroup',
  @destination_location   = 'sql2025-ces.servicebus.windows.net/ces-hub',
  @destination_credential = SqlCesCredential,
  @destination_type       = 'AzureEventHubsAmqp'
```

In this code:

- **@stream_group_name:** Creates an event stream group named `SqlCesGroup`

- **@destination_location:** Tells SQL Server to send change events to the Azure Event Hub at `sql2025-ces.servicebus.windows.net/ces-hub`.
  > This syntax describes an Event Hub named `ces-hub`, which exists in an Event Hub namespace named `sql2025-ces`.

- **@destination_credential:** The credential `SqlCesCredential` provides the necessary access permissions to the Event Hub, which you've already configured with the approprate SAS token.

- **@destination_type:** This parameter specifies that the events will be sent using the AMQP protocol, which is the standard for Azure Event Hubs.
  > AMQP stands for Advanced Message Queuing Protocol, a protocol used for message-oriented middleware that allows for efficient and reliable message delivery.

### Create Demo Tables

These tables model a basic order processing system. Each definition is shown separately below.

#### Product

Stores a catalog of available products, including pricing and inventory level.

```sql
CREATE TABLE Product (
    ProductId       int IDENTITY PRIMARY KEY,
    Name            varchar(80),
    Color           varchar(15),
    Category        varchar(20),
    UnitPrice       decimal(8, 2),
    ItemsInStock    smallint
)
GO
```

#### Customer

Represents customers placing orders.

```sql
CREATE TABLE Customer (
    CustomerId      int IDENTITY PRIMARY KEY,
    CustomerName    varchar(50),
    City            varchar(20)
)
GO
```

#### Order

Captures individual orders placed by customers.

```sql
CREATE TABLE [Order] (
    OrderId     int IDENTITY PRIMARY KEY,
    CustomerId  int REFERENCES Customer(CustomerId),
    OrderDate   datetime2
)
GO
```

#### OrderDetail

Tracks the product and quantity details in each order.

```sql
CREATE TABLE OrderDetail (
    OrderDetailId   int IDENTITY PRIMARY KEY,
    OrderId         int REFERENCES [Order](OrderId),
    ProductId       int REFERENCES Product(ProductId),
    Quantity        smallint
)
GO
```

#### TableWithNoPK

This table will be used to demonstrate how CES behaves when a table lacks a primary key and does not include all columns.

```sql
CREATE TABLE TableWithNoPK (
    Id      int IDENTITY,
    Datacol varchar(50)
)
GO
```

### Create Trigger

This trigger ensures product stock levels are automatically updated when order lines are added, changed, or deleted. The purpose of this trigger is to demonstrate that Change Event Streaming can capture the "side-effect" on data changes resulting from triggers.

```sql
CREATE TRIGGER trgUpdateItemsInStock ON OrderDetail AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON

    -- Handle Insert
    IF EXISTS (SELECT * FROM inserted) AND NOT EXISTS (SELECT * FROM deleted)
        UPDATE Product
        SET ItemsInStock = p.ItemsInStock - i.Quantity
        FROM
            Product AS p
            INNER JOIN inserted AS i ON p.ProductId = i.ProductId

    -- Handle Update
    ELSE IF EXISTS (SELECT * FROM inserted) AND EXISTS (SELECT * FROM deleted) AND UPDATE(Quantity)
        UPDATE Product
        SET ItemsInStock = p.ItemsInStock + d.Quantity - i.Quantity
        FROM
            Product AS p
            INNER JOIN inserted AS i ON p.ProductId = i.ProductId
            INNER JOIN deleted AS d ON p.ProductId = d.ProductId

    -- Handle Delete
    ELSE IF EXISTS (SELECT * FROM deleted) AND NOT EXISTS (SELECT * FROM inserted)
        UPDATE Product
        SET ItemsInStock = p.ItemsInStock + d.Quantity
        FROM
            Product AS p
            INNER JOIN deleted AS d ON p.ProductId = d.ProductId
END
GO
```

With this trigger in place, any changes to the OrderDetail table will automatically adjust the stock levels in the Product table. This is a common pattern in order management systems to ensure inventory levels are always accurate. As a result, events for products affected by order detail changes will also be generated, demonstrating how CES captures cascading changes across related tables that leverage DML triggers.

### Create Stored Procedures

Each stored procedure represents a key business operation. We'll create them one by one below.

#### CreateOrder

This procedure inserts a new order row using a supplied CustomerId. It prints the newly created order number to the console.

```sql
CREATE OR ALTER PROC CreateOrder
    @CustomerId int
AS
BEGIN
    SET NOCOUNT ON
    INSERT INTO [Order](CustomerId) VALUES (@CustomerId)
    PRINT 'Order created: #' || SCOPE_IDENTITY()
END
GO
```

#### CancelOrder

This procedure deletes an order and its associated order lines. It uses an explicit transaction to ensure that the delete is all-or-nothing.

We use `SET XACT_ABORT ON` so that any error (such as a foreign key violation) automatically rolls back the entire transaction, ensuring no partial deletes.

```sql
CREATE OR ALTER PROC CancelOrder @OrderId int
AS
BEGIN
    SET NOCOUNT ON
    SET XACT_ABORT ON
    BEGIN TRANSACTION
        DELETE FROM OrderLine WHERE OrderId = @OrderId
        DELETE FROM [Order] WHERE OrderId = @OrderId
    COMMIT TRANSACTION
END
GO
```

#### AddOrderLine

This procedure inserts a new order line for a given order and product, with the specified quantity.

```sql
CREATE OR ALTER PROC AddOrderLine @OrderId int, @ProductId int, @Quantity smallint
AS
BEGIN
    SET NOCOUNT ON
    INSERT INTO OrderLine(OrderId, ProductId, Quantity)
    VALUES (@OrderId, @ProductId, @Quantity)
END
GO
```

### Insert Sample Data

Now populate the tables with product, customer, and miscellaneous data.

```sql
-- Add some products and customers
INSERT INTO Product (Name, Colour, Category, UnitPrice, ItemsInStock, Description) 
VALUES 
  ('Canon EOS R5 Mirrorless Camera', 'Black', 'Camera', 3899.99, 10, N'High-performance mirrorless camera with 45MP full-frame sensor, 8K video, and advanced  autofocus.'),
  ('Nikon Z6 II Mirrorless Camera', 'Black', 'Camera', 1996.95, 8, N'24.5MP mirrorless camera with dual processors, improved autofocus, and 4K video.'),
  ('Sony Alpha a7 III Camera', 'Black', 'Camera', 1998.00, 12, N'Full-frame mirrorless camera with 24.2MP sensor, fast autofocus, and excellent low-light performance.'),
  ('Fujifilm X-T5 Mirrorless Camera', 'Silver', 'Camera', 1699.00, 6, N'Compact APS-C mirrorless camera with 40.2MP sensor and vintage design.'),
  ('Olympus OM-D E-M1 Mark III', 'Black', 'Camera', 1499.00, 5, N'Micro Four Thirds mirrorless camera with built-in image stabilization and weatherproof design.'),
  ('Canon EF 24-70mm f/2.8L II USM Lens', 'Black', 'Lens', 1899.00, 7, N'Professional-grade zoom lens with constant f/2.8 aperture and high image quality.'),
  ('Sony FE 70-200mm f/2.8 GM OSS Lens', 'White', 'Lens', 2598.00, 4, N'Full-frame telephoto zoom lens with fast autofocus and optical stabilization.'),
  ('Nikon AF-S NIKKOR 50mm f/1.8G Lens', 'Black', 'Lens', 216.95, 15, N'Compact and versatile prime lens with fast f/1.8 aperture for low light.'),
  ('Sigma 18-35mm f/1.8 DC HSM Art Lens', 'Black', 'Lens', 799.00, 9, N'Wide-angle zoom lens with constant f/1.8 aperture and sharp optics.'),
  ('Fujifilm XF 56mm f/1.2 R Lens', 'Black', 'Lens', 999.00, 6, N'Portrait lens with wide f/1.2 aperture for beautiful background blur.'),
  ('GoPro HERO12 Black Action Camera', 'Black', 'Camera', 399.99, 20, N'Rugged, waterproof action camera with 5.3K video and advanced stabilization.'),
  ('DJI Air 2S Drone', 'Gray', 'Drone', 999.00, 3, N'Compact drone with 1-inch sensor, 5.4K video, and 31 minutes of flight time.'),
  ('Rode VideoMic Pro+', 'Black', 'Accessory', 299.00, 8, N'Shotgun microphone for DSLR and mirrorless cameras, ideal for vlogging and video production.'),
  ('Manfrotto Befree Advanced Tripod', 'Red/Black', 'Tripod', 199.99, 10, N'Portable, lightweight aluminum tripod with ball head and quick setup.'),
  ('SanDisk Extreme PRO 128GB SDXC UHS-I Card', 'Black', 'Accessory', 29.99, 50, N'High-speed memory card with up to 170MB/s read speeds for 4K video.'),
  ('Lowepro ProTactic 450 AW II Backpack', 'Black', 'Accessory', 299.95, 7, N'Rugged camera backpack with customizable interior and weather protection.'),
  ('Canon Speedlite 430EX III-RT Flash', 'Black', 'Lighting', 249.00, 10, N'Powerful external flash with radio-controlled wireless functionality.'),
  ('Sony NP-FZ100 Rechargeable Battery', 'Black', 'Accessory', 78.00, 25, N'High-capacity battery for Sony Alpha mirrorless cameras.'),
  ('B+W 77mm UV Filter', 'Black', 'Accessory', 59.95, 15, N'Multi-coated UV filter to reduce haze and protect your lens.'),
  ('Elgato Key Light', 'Black', 'Lighting', 199.99, 12, N'LED panel light with adjustable brightness and color temperature for streaming or video calls.'),
  ('Tamron 28-75mm f/2.8 Di III RXD Lens', 'Black', 'Lens', 879.00, 8, N'Lightweight standard zoom lens for Sony E-mount mirrorless cameras.'),
  ('Zeiss Otus 55mm f/1.4 Lens', 'Black', 'Lens', 3999.00, 2, N'Ultra-high-quality prime lens with exceptional sharpness and bokeh.'),
  ('DJI Ronin-S Gimbal Stabilizer', 'Black', 'Accessory', 499.00, 5, N'3-axis handheld gimbal stabilizer for smooth and cinematic camera movements.'),
  ('Godox AD200Pro TTL Pocket Flash', 'Black', 'Lighting', 349.00, 6, N'Compact, portable flash with 200Ws output and TTL compatibility.'),
  ('Peak Design Slide Camera Strap', 'Ash', 'Accessory', 69.95, 18, N'Comfortable, quick-adjust camera strap with durable construction.'),
  ('Think Tank Airport Security V3.0 Roller Bag', 'Black', 'Accessory', 429.00, 4, N'Carry-on compatible rolling camera bag with TSA locks and ample storage.'),
  ('SmallRig Cage for Sony a7 III', 'Black', 'Accessory', 89.00, 10, N'Custom-fit camera cage for video production with accessory mounting points.'),
  ('Tether Tools JerkStopper Cable Management System', 'Black', 'Accessory', 19.99, 30, N'Secures cables to prevent accidental disconnections during tethered shooting.'),
  ('Gitzo GT1545T Series 1 Traveler Carbon Fiber Tripod', 'Black', 'Tripod', 799.99, 3, N'Lightweight, durable carbon fiber tripod with compact folding design.'),
  ('Viltrox EF-EOS M2 Lens Mount Adapter', 'Black', 'Accessory', 149.00, 12, N'Adapter with 0.71x focal reducer for mounting Canon EF lenses on mirrorless cameras.');

INSERT INTO Customer (CustomerName, City, Comment) VALUES
  ('Shutter Bros Wholesale', 'New York', N'Orders monthly; prefers Canon stock'),
  ('Aperture Supply Co.', 'Los Angeles', N'Specializes in mirrorless camera gear'),
  ('LensCraft Distributors', 'Chicago', N'Sells mainly to local photo studios'),
  ('SnapShot Traders', 'Houston', N'New account—trial order placed last week'),
  ('FocusPro Resale', 'Phoenix', N'Buys in bulk before holiday season'),
  ('CamZone Partners', 'Philadelphia', N'Interested in film cameras and accessories'),
  ('ZoomMax Wholesale', 'San Antonio', N'Bulk buyer of Nikon lenses'),
  ('PixelPoint LLC', 'San Diego', N'Resells primarily through online channels'),
  ('Click & Capture', 'Dallas', N'Specializes in DSLR kits for schools'),
  ('PhotoFlow Resellers', 'San Jose', N'Supplies small independent camera shops'),
  ('LightHouse Imaging Supply', 'Austin', N'Strong Q4 sales history'),
  ('Frame & Focus Inc.', 'Jacksonville', N'Needs better rates on tripods'),
  ('StudioHub Traders', 'Fort Worth', N'Requests regular stock updates'),
  ('CineGear USA', 'Columbus', N'Film gear specialists'),
  ('PrimePixels Resale', 'Charlotte', N'Focus on compact cameras for tourists');

INSERT INTO TableWithNoPK (Datacol) VALUES
  ('Blue'),
  ('Car'),
  ('Fast'),
  ('Hello hey')
```

### Add Tables to the Stream Group

Link each table to the stream group and configure how much data CES includes in the event payload. Two key options control this:

* `@include_old_values`: When set to 1, CES includes the *previous* values of each column for UPDATE and DELETE operations. Use this when you want to compare old vs. new values.
* `@include_all_columns`: When set to 1, CES includes *all* columns of the row even if only one column changes. When set to 0, only primary key and changed columns are included.

In this lab:

* `Product`, `Order`, and `OrderLine` include old values to detect stock changes or order modifications.
* `Customer` does not include old values but does include all columns, which is useful for simpler data monitoring.
* `TableWithNoPK` includes neither old values nor all columns. This highlights the limitations of tracking change events on poorly defined schemas.

> Be sure to reference the same stream group name you created earlier, appending your first and last name to ensure uniqueness.

```sql
EXEC sys.sp_add_object_to_event_stream_group
    @stream_group_name = 'SqlCesGroup_<firstname_lastname>',
    @object_name = 'dbo.Product',
    @include_old_values = 1,
    @include_all_columns = 0

EXEC sys.sp_add_object_to_event_stream_group
    @stream_group_name = 'SqlCesGroup_<firstname_lastname>',
    @object_name = 'dbo.Customer',
    @include_old_values = 0,
    @include_all_columns = 1

EXEC sys.sp_add_object_to_event_stream_group
    @stream_group_name = 'SqlCesGroup_<firstname_lastname>',
    @object_name = 'dbo.Order',
    @include_old_values = 1,
    @include_all_columns = 0

EXEC sys.sp_add_object_to_event_stream_group
    @stream_group_name = 'SqlCesGroup_<firstname_lastname>',
    @object_name = 'dbo.OrderLine',
    @include_old_values = 1,
    @include_all_columns = 0

EXEC sys.sp_add_object_to_event_stream_group
    @stream_group_name = 'SqlCesGroup_<firstname_lastname>',
    @object_name = 'dbo.TableWithNoPK',
    @include_old_values = 0,
    @include_all_columns = 0
```

### Help Views

Inspect the current CES configuration for each table.

```sql
EXEC sp_help_change_feed_table @source_schema = 'dbo', @source_name = 'Product'
EXEC sp_help_change_feed_table @source_schema = 'dbo', @source_name = 'Customer'
EXEC sp_help_change_feed_table @source_schema = 'dbo', @source_name = 'Order'
EXEC sp_help_change_feed_table @source_schema = 'dbo', @source_name = 'OrderLine'
EXEC sp_help_change_feed_table @source_schema = 'dbo', @source_name = 'TableWithNoPK'
```

### Check for Errors

Query this DMV to diagnose any issues with change event publishing.

```sql
SELECT * FROM sys.dm_change_feed_errors ORDER BY entry_time DESC
```

Continue with **Lab 2** to build the C# consumer.
