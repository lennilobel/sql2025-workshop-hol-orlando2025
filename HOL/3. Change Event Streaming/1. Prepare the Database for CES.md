# Prepare the Database for CES

In this first lab, you will configure a SQL Server 2025 database for Change Event Streaming (CES), create a stream group, and define schema and procedures to simulate transactional activity.

This lab uses a **shared Event Hub** provisioned by your instructor. Each student will later use a **unique consumer group name** in the C# application to ensure events are isolated.

---

### Create and Configure the Database

Run the following T-SQL to create the `CesDemo` database and ensure it uses the correct recovery model and owner.

```sql
USE master
GO

CREATE DATABASE CesDemo
GO

-- Make sure the owner is sa. If the owner is an Entra ID identity it won't work
ALTER AUTHORIZATION ON DATABASE::CesDemo TO sa
GO

USE CesDemo
GO

-- Set database to full recovery mode
ALTER DATABASE CesDemo SET RECOVERY FULL
```

### Create the Database Master Key

You must create a database master key to securely store the credential for CES.

```sql
IF NOT EXISTS (SELECT * FROM sys.symmetric_keys WHERE name = '##MS_DatabaseMasterKey##')
    CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'H@rd2Gue$$P@$$w0rd'
```

### Create the Credential Used by CES

This credential holds the SAS token that allows SQL Server to push events to Event Hubs. Replace the placeholder with the token provided by your instructor.

```sql
CREATE DATABASE SCOPED CREDENTIAL SqlCesCredential
WITH
    IDENTITY = 'SHARED ACCESS SIGNATURE',
    SECRET = 'SharedAccessSignature sr=https%3a%2f%2fsql2025-ces.servicebus.windows.net%2fces-hub&sig=z%2fAetLX7A680Ui95t86yxjzgWn5IUUYEvZC5s6CgH0g%3d&se=1764455706&skn=ces-policy'
```

### Enable CES

Enable Change Event Streaming for the database and verify the status.

```sql
SELECT * FROM sys.databases WHERE is_event_stream_enabled = 1

EXEC sys.sp_enable_event_stream

SELECT * FROM sys.databases WHERE is_event_stream_enabled = 1
```

### Create the Event Stream Group

This stream group will define how and where change events are sent. Use the destination and credential as configured earlier.

```sql
EXEC sys.sp_create_event_stream_group
    @stream_group_name      = 'SqlCesGroup',
    @destination_type       = 'AzureEventHubsAmqp',
    @destination_location   = 'sql2025-ces.servicebus.windows.net/ces-hub',
    @destination_credential = SqlCesCredential,
    @max_message_size_bytes = 1000000,
    @partition_key_scheme   = 'None'
GO
```

### Create Demo Tables

These tables model a basic order processing system. Each definition is shown separately below.

#### Product

Stores a catalog of available products, including pricing, inventory level, and description.

```sql
CREATE TABLE Product (
    ProductId       int             NOT NULL IDENTITY PRIMARY KEY,
    Name            varchar(80)     NOT NULL,
    Colour          varchar(15),
    Category        varchar(20)     NOT NULL,
    UnitPrice       decimal(8, 2)   NOT NULL,
    ItemsInStock    smallint        NOT NULL DEFAULT 0,
    Description     nvarchar(4000)
)
GO
```

#### Customer

Represents customers placing orders. Starts identity seed at 1000.

```sql
CREATE TABLE Customer (
    CustomerId      int             NOT NULL IDENTITY(1000, 1) PRIMARY KEY,
    CustomerName    varchar(50)     NOT NULL,
    City            varchar(20)     NOT NULL,
    Comment         nvarchar(4000)
)
GO
```

#### Order

Captures individual orders placed by customers. Uses a default order date and references `Customer`.

```sql
CREATE TABLE [Order] (
    OrderId     int     NOT NULL IDENTITY(2000, 1) PRIMARY KEY,
    CustomerId  int     NOT NULL REFERENCES Customer(CustomerId),
    OrderDate   date    NOT NULL DEFAULT CURRENT_DATE
)
GO
```

#### OrderLine

Tracks the products and quantities included in each order. References `Order` and `Product`.

```sql
CREATE TABLE OrderLine (
    OrderLineId uniqueidentifier    NOT NULL DEFAULT NEWSEQUENTIALID() PRIMARY KEY,
    OrderId     int                 NOT NULL REFERENCES [Order](OrderId),
    ProductId   int                 NOT NULL REFERENCES Product(ProductId),
    Quantity    smallint            NOT NULL
)
GO
```

#### TableWithNoPK

Used to demonstrate how CES behaves when a table lacks a primary key and does not include all columns.

```sql
CREATE TABLE TableWithNoPK (
    Id      int         NOT NULL IDENTITY,
    Datacol varchar(50) NOT NULL
)
GO
```

### Create Trigger

This trigger ensures product stock levels are automatically updated when order lines are added, changed, or deleted.

```sql
CREATE TRIGGER trg_UpdateItemsInStock ON OrderLine AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON

    -- Handle Insert
    IF EXISTS (SELECT * FROM inserted) AND NOT EXISTS (SELECT * FROM deleted)
    BEGIN
        UPDATE Product
        SET ItemsInStock = p.ItemsInStock - i.Quantity
        FROM
            Product AS p
            INNER JOIN inserted AS i ON p.ProductId = i.ProductId
    END
    ELSE IF EXISTS (SELECT * FROM inserted) AND EXISTS (SELECT * FROM deleted) AND UPDATE(Quantity)
    BEGIN
        -- Handle Update
        UPDATE Product
        SET ItemsInStock = p.ItemsInStock + d.Quantity - i.Quantity
        FROM
            Product AS p
            INNER JOIN inserted AS i ON p.ProductId = i.ProductId
            INNER JOIN deleted AS d ON p.ProductId = d.ProductId
    END
    ELSE IF EXISTS (SELECT * FROM deleted) AND NOT EXISTS (SELECT * FROM inserted)
    BEGIN
        -- Handle Delete
        UPDATE Product
        SET ItemsInStock = p.ItemsInStock + d.Quantity
        FROM
            Product AS p
            INNER JOIN deleted AS d ON p.ProductId = d.ProductId
    END
END
GO
```

### Create Stored Procedures

Each stored procedure represents a key business operation. We'll create them one by one below.

#### CreateOrder

This procedure inserts a new order row using a supplied CustomerId. It prints the newly created order number to the console.

```sql
CREATE OR ALTER PROC CreateOrder
    @CustomerId int
AS
BEGIN
    SET NOCOUNT ON
    INSERT INTO [Order](CustomerId) VALUES (@CustomerId)
    PRINT 'Order created: #' || SCOPE_IDENTITY()
END
GO
```

#### CancelOrder

This procedure deletes an order and its associated order lines. It uses an explicit transaction to ensure that the delete is all-or-nothing.

We use `SET XACT_ABORT ON` so that any error (such as a foreign key violation) automatically rolls back the entire transaction, ensuring no partial deletes.

```sql
CREATE OR ALTER PROC CancelOrder @OrderId int
AS
BEGIN
    SET NOCOUNT ON
    SET XACT_ABORT ON
    BEGIN TRANSACTION
        DELETE FROM OrderLine WHERE OrderId = @OrderId
        DELETE FROM [Order] WHERE OrderId = @OrderId
    COMMIT TRANSACTION
END
GO
```

#### AddOrderLine

This procedure inserts a new order line for a given order and product, with the specified quantity.

```sql
CREATE OR ALTER PROC AddOrderLine @OrderId int, @ProductId int, @Quantity smallint
AS
BEGIN
    SET NOCOUNT ON
    INSERT INTO OrderLine(OrderId, ProductId, Quantity)
    VALUES (@OrderId, @ProductId, @Quantity)
END
GO
```

### Insert Sample Data

Now populate the tables with product, customer, and miscellaneous data.

```sql
-- Product and Customer data as provided earlier --
-- Omitted here for brevity in this snippet --
```

### Add Tables to the Stream Group

Link each table to the stream group and configure how much data CES includes in the event payload. Two key options control this:

* `@include_old_values`: When set to 1, CES includes the *previous* values of each column for UPDATE and DELETE operations. Use this when you want to compare old vs. new values.
* `@include_all_columns`: When set to 1, CES includes *all* columns of the row even if only one column changes. When set to 0, only primary key and changed columns are included.

In this lab:

* `Product`, `Order`, and `OrderLine` include old values to detect stock changes or order modifications.
* `Customer` does not include old values but does include all columns, which is useful for simpler data monitoring.
* `TableWithNoPK` includes neither old values nor all columns. This highlights the limitations of tracking change events on poorly defined schemas.

```sql
EXEC sys.sp_add_object_to_event_stream_group
    @stream_group_name = 'SqlCesGroup',
    @object_name = 'dbo.Product',
    @include_old_values = 1,
    @include_all_columns = 0

EXEC sys.sp_add_object_to_event_stream_group
    @stream_group_name = 'SqlCesGroup',
    @object_name = 'dbo.Customer',
    @include_old_values = 0,
    @include_all_columns = 1

EXEC sys.sp_add_object_to_event_stream_group
    @stream_group_name = 'SqlCesGroup',
    @object_name = 'dbo.Order',
    @include_old_values = 1,
    @include_all_columns = 0

EXEC sys.sp_add_object_to_event_stream_group
    @stream_group_name = 'SqlCesGroup',
    @object_name = 'dbo.OrderLine',
    @include_old_values = 1,
    @include_all_columns = 0

EXEC sys.sp_add_object_to_event_stream_group
    @stream_group_name = 'SqlCesGroup',
    @object_name = 'dbo.TableWithNoPK',
    @include_old_values = 0,
    @include_all_columns = 0
```

### Help Views

Inspect the current CES configuration for each table.

```sql
EXEC sp_help_change_feed_table @source_schema = 'dbo', @source_name = 'Product'
EXEC sp_help_change_feed_table @source_schema = 'dbo', @source_name = 'Customer'
EXEC sp_help_change_feed_table @source_schema = 'dbo', @source_name = 'Order'
EXEC sp_help_change_feed_table @source_schema = 'dbo', @source_name = 'OrderLine'
EXEC sp_help_change_feed_table @source_schema = 'dbo', @source_name = 'TableWithNoPK'
```

### Check for Errors

Query this DMV to diagnose any issues with change event publishing.

```sql
SELECT * FROM sys.dm_change_feed_errors ORDER BY entry_time DESC
```

Continue with **Lab 2** to build the C# consumer.
