# Generate Events from Change Data

In this lab, you will:

* Use T-SQL to modify data in the `CesDemo` database.
* Observe how these changes generate events in Event Hub.
* Observe how your running C# console app receives and processes events generated in Event Hub.

### Open SQL Server Management Studio

Connect to your local SQL Server 2025 instance and open a new query window targeting your own `CesDemo` database.

### Run Sample Modifications

These T-SQL commands will modify the tables you added to the CES stream group.

#### Insert into Customer

This statement adds a new customer to the `Customer` table. Because this table is included in your CES stream group, this insert will generate an `INS` (insert) event visible in the console output.

```sql
INSERT INTO Sales.Customer (CustomerName) VALUES ('Contoso Corporation');
```

#### Insert into Product

Next, insert a product into the `Product` table. This will demonstrate a basic insert with additional column values that will be captured and displayed in the event payload.

```sql
INSERT INTO Sales.Product (ProductName, InStock) VALUES ('Widget', 100);
```

#### Insert into Order

This insert creates a new order and references an existing customer. Note how the order date defaults to the current date and time.

```sql
INSERT INTO Sales.Order (CustomerId, OrderDate) VALUES (1, GETDATE());
```

#### Insert into OrderLine

Here you associate a product with an order by inserting a line item. Because this table has a GUID primary key, you may see different behavior in the key fields compared to identity columns.

```sql
INSERT INTO Sales.OrderLine (OrderId, ProductId, Quantity) VALUES (1, 1, 10);
```

#### Update Product

This update simulates product inventory reduction (e.g., after an order is placed). Because `include_old_values` is enabled for the `Product` table, the old stock value should appear in the event payload.

```sql
UPDATE Sales.Product SET InStock = InStock - 10 WHERE ProductId = 1;
```

#### Delete from OrderLine

This delete simulates removal of an order line. The delete event will include the old values of the deleted row, as configured.

```sql
DELETE FROM Sales.OrderLine WHERE OrderLineId = 1;
```

### Watch the Console Output

The `Sales.OrderLine` table includes an `AFTER INSERT` and `AFTER DELETE` trigger named `trg_UpdateItemsInStock`. This trigger automatically adjusts the `InStock` value of related `Product` rows whenever an order line is added or removed. Because this update is a side effect of your insert or delete operation, it produces an additional CES event. As a result, a single data change in `OrderLine` may generate multiple events: one for the row you modified, and one or more for triggered downstream updates.

As soon as you run each command above, your running `CESClient` console application should immediately receive and display a change event in the console window.

You’ll see:

* Operation type (INS, UPD, DEL)
* A list of column names and values
* Color-coded output:

  * Green for inserts
  * Yellow for updated values
  * Red for deleted rows

The metadata at the top will also confirm:

* Table and schema name
* Event time
* Logical event identifier (student name or ID)

> 🧪 Experiment with updates that modify only some columns. Try inserting or updating in `TableWithNoPK` and notice how the output differs due to missing primary keys and limited configuration.
