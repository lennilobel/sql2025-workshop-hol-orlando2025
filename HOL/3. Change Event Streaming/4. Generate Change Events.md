# Generate Change Events

In this lab, you will:

* Use T-SQL to modify data in the `CesDemo` database.
* Observe how these changes generate events in Event Hub.
* Observe how your running C# console app receives and processes events generated in Event Hub.

If you still have the SSMS query window open that you used to setup the database, you can continue working in that window. If not, open a new query window now and select your database from the dropdown list at the top of the window, which should be `CesDemo_<firstname_lastname_>` (e.g., `CesDemo_john_smith`).

> **Tip:** Consider tiling the C# console application and SSMS side-by-side on your screen, so that you can monitor the application on the left while you apply database changes on the right. To do this, first select the console application and press `Windows + LeftArrow` to snap it to the left side of your screen. Then select the SSMS window to snap it to the right side.

## Create an Order

Run this statement to create a new order for customer ID 1.

```sql
EXEC CreateOrder @CustomerId = 1
```

This inserts a new order into the `Order` table and displays the new order ID, which should be 1.

Because the `Order` table is included in your CES stream group, observe that this insert also generates an `INS` (insert) event that gets received and display by the console application.

> **Note:** It may take some time before the first event is received. Be patient and wait for the console application to display the event. Subsequent events should be received much faster, typically within a few seconds. If you don't see the first event appear after a one minute, then you have an issue that needs to be resolved. Also, you are likely to see messages appear for events received and ignored because they were generated by other attendees.

## Create Order Details

Now create the first order detail for the new order, specifying a quantity of 2 for product ID 1.

```sql
EXEC CreateOrderDetail @OrderId = 1, @ProductId = 1, @Quantity = 2
```

This inserts a new order line into the `OrderDetail` table and displays the new order detail ID, which should be 1.

Because the `OrderDetail` table is also part of your CES stream group, you should observe that this insert also generates an `INS` event that is received and displayed by the console application.

Furthermore, recall that we defined a trigger on the `OrderDetail` table that automatically updates the `InStock` value of the associated product in the `Product` table. Because the `Product` table is also part of your CES stream group, this means that you should observe an additional event for the updated product data. This event will be an `UPD` (update) event for the `Product` table, showing the new stock value after the order detail was added. Since the order quantity was 2, you should observe that the `InStock` value for the product ID 1 has been decreased by 2 (from 10 to 8).

Now create the second order detail for the same order, specifying a quantity of 1 for product ID 2.

```sql
EXEC CreateOrderDetail @OrderId = 1, @ProductId = 2, @Quantity = 1
```

This inserts the next new order line into the `OrderDetail` table and displays the new order detail ID, which should be 2.

Oncec again, observe that this insert generates an `INS` event for the new `OrderDetail` row, plus an `UPD` for the affected `Product` row updated by the trigger (this time, because the quantity is 1, the stock for product ID 2 should be decreased by 1, from 8 to 7).

## Delete the Order

Now we'll call the `DeleteOrder` stored procedure to delete the order we just created.

```sql
EXEC DeleteOrder @OrderId = 1
```

This will also delete the associated order details, and because both the `Order` and `OrderDetail` tables are part of your CES stream group, this will generate events for both the deleted order and its details. Furthermore, the trigger on the `OrderDetail` table will also update the `InStock` value of the associated products, generating additional events for those updates on the `Product` table.

The result should be a total of 5 events generated:

* 2 `DEL` events for the deleted `OrderDetail` rows
* 1 `DEL` event for the deleted `Order` row
* 2 `UPD` events for the `Product` rows, reflecting the stock updates after the order details were deleted.

## Update a Customer

Now run this statement to change the city of customer ID 1 to "Chicago":

```sql
UPDATE Customer SET City = 'Chicago' WHERE CustomerId = 1
```

This update will generate an `UPD` event for the `Customer` table, and will be received and displayed by the console application just like the events generated for any tables that are part of the CES stream group. However, we configured the stream group for the `Customer` table not to include old values. Therefore, you will observe that the event only includes the new value for the `City` column, and not the previous value (which was "New York").

## Update Multiple Products

This next statement performs a bulk update that raises the price of all products in the "Camera" category by 20%:

```sql
UPDATE Product SET UnitPrice = UnitPrice * 0.8 WHERE Category = 'Camera'
```

We have two products in the "Camera" category, so this update will generate two `UPD` events that get received and displayed by the console application.

Note that we configured the stream group for the `Product` table to include old values, so you will see both the old and new values for the `UnitPrice` column in the events generated by this update. We also configured the stream group not to include all values; that is, to include only modified values, which is the `UnitPrice` in this case. Still, you will see that the `ProductId` is also included, because that is the table's primary key column, which is always included in the generated `UPD` event regardless of whether or not you have configured the stream group to include all values.

## Update a Table with No Primary Key

Finally, run this statement to update the `TableWithNoPK` table, which does not have a primary key:

```sql
UPDATE TableWithNoPK SET ItemName = 'Stove' WHERE Id = 3
```

The result should be an `UPD` event for the `TableWithNoPK` table, which will be received and displayed by the console application. However, because this table does not have a primary key, the event will not include any key columns, and it will only include the modified column (`Datacol`) with its new value "Stove".

This highlights the importance of having a primary key in tables that are part of a CES stream group, as it allows the system to uniquely identify rows and generate meaningful events. Without a primary key, the events generated will be useless for tracking changes or processing data downstream.

**Congratulations! You have successfully implemented Change Event Streaming.**

Stop the console application by selecting it and pressing any key.

Now it's time to clean up your environment by deleting the database. 

___

▶ [Lab: Cleanup](https://github.com/lennilobel/sql2025-workshop-hol-orlando2025/blob/main/HOL/3.%20Change%20Event%20Streaming/4.%20Cleanup.md)
